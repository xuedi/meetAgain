{% extends 'admin/base.html.twig' %}

{% block javascripts %}
    <script src="{{ '/javascript/chart.js' }}"></script>
{% endblock %}

{% block content %}

    <div class="container">
        <div class="columns">
            <div class="column is-8">
                <div class="buttons has-addons is-centered">
                    <a class="button" href="{{ path('app_admin', {'week': time.weekPrevious, 'year': time.year}) }}">
                        <span class="icon"><i class="fa fa-arrow-left"></i></span>
                    </a>
                    <div class="button">
                        <span class="mr-2">Dashboard for the week: <b>{{ time.week }}</b></span>
                        <span class="has-text-grey is-size-7">({{ time.weekDetails }})</span>
                    </div>
                    <a class="button" href="{{ path('app_admin', {'week': time.weekNext, 'year': time.year}) }}">
                        <span class="icon"><i class="fa fa-arrow-right"></i></span>
                    </a>
                </div>

                {% if actionItems.reportedImages > 0 or actionItems.pendingTranslations > 0 or actionItems.staleEmails > 0 or unverifiedCount > 0 or loginAttempts.failed > 0 or commandStats.failed > 0 or emailDeliveryStats.failed > 0 %}
                <div class="box has-background-warning-light">
                    <h2 class="title is-6"><span class="icon"><i class="fa fa-exclamation-triangle"></i></span> Action Required</h2>
                    <div class="tags">
                        {% if actionItems.reportedImages > 0 %}
                            <a href="{{ path('app_admin_image') }}" class="tag is-danger is-medium">
                                <span class="icon"><i class="fa fa-flag"></i></span>
                                <span>{{ actionItems.reportedImages }} Reported Image{{ actionItems.reportedImages > 1 ? 's' : '' }}</span>
                            </a>
                        {% endif %}
                        {% if actionItems.pendingTranslations > 0 %}
                            <a href="{{ path('app_admin_translation_suggestion') }}" class="tag is-warning is-medium">
                                <span class="icon"><i class="fa fa-language"></i></span>
                                <span>{{ actionItems.pendingTranslations }} Pending Translation{{ actionItems.pendingTranslations > 1 ? 's' : '' }}</span>
                            </a>
                        {% endif %}
                        {% if actionItems.staleEmails > 0 %}
                            <span class="tag is-danger is-medium">
                                <span class="icon"><i class="fa fa-envelope"></i></span>
                                <span>{{ actionItems.staleEmails }} Stale Email{{ actionItems.staleEmails > 1 ? 's' : '' }} (>1h)</span>
                            </span>
                        {% endif %}
                        {% if unverifiedCount > 0 %}
                            <a href="{{ path('app_admin_user') }}" class="tag is-info is-medium">
                                <span class="icon"><i class="fa fa-user-clock"></i></span>
                                <span>{{ unverifiedCount }} Unverified Account{{ unverifiedCount > 1 ? 's' : '' }}</span>
                            </a>
                        {% endif %}
                        {% if loginAttempts.failed > 0 %}
                            <span class="tag is-warning is-medium">
                                <span class="icon"><i class="fa fa-shield-alt"></i></span>
                                <span>{{ loginAttempts.failed }} Failed Login{{ loginAttempts.failed > 1 ? 's' : '' }} (24h)</span>
                            </span>
                        {% endif %}
                        {% if commandStats.failed > 0 %}
                            <span class="tag is-danger is-medium">
                                <span class="icon"><i class="fa fa-terminal"></i></span>
                                <span>{{ commandStats.failed }} Failed Command{{ commandStats.failed > 1 ? 's' : '' }} (24h)</span>
                            </span>
                        {% endif %}
                        {% if emailDeliveryStats.failed > 0 %}
                            <span class="tag is-danger is-medium">
                                <span class="icon"><i class="fa fa-envelope-open"></i></span>
                                <span>{{ emailDeliveryStats.failed }} Failed Email{{ emailDeliveryStats.failed > 1 ? 's' : '' }} (24h)</span>
                            </span>
                        {% endif %}
                    </div>
                </div>
                {% endif %}

                <div class="box">
                    <h2 class="title is-6">Members to approve</h2>
                    {% if needForApproval|length == 0 %}
                        <p class="has-text-grey">No members to approve</p>
                    {% else %}
                        <table class="table is-fullwidth is-narrow">
                            <tbody>
                            {% for user in needForApproval %}
                                {% if user.status.value == 1 %}
                                    <tr>
                                        <td>{{ user.createdAt|date('Y-m-d') }}</td>
                                        <td>{{ user.email }}</td>
                                        <td>{{ user.name }}</td>
                                        <td class="has-text-right">
                                            <a href="{{ path('app_admin_user_approve', {'id': user.id}) }}" class="button is-small is-success">
                                                <span class="icon"><i class="fa fa-check"></i></span>
                                            </a>
                                            <a href="{{ path('app_admin_user_deny', {'id': user.id}) }}" class="button is-small is-danger">
                                                <span class="icon"><i class="fa fa-times"></i></span>
                                            </a>
                                        </td>
                                    </tr>
                                {% endif %}
                            {% endfor %}
                            </tbody>
                        </table>
                    {% endif %}
                </div>

                <div class="columns">
                    <div class="column is-6">
                        <div class="box">
                            <h2 class="title is-6">Upcoming Events</h2>
                            {% if upcomingEvents|length == 0 %}
                                <p class="has-text-grey">No upcoming events</p>
                            {% else %}
                                <table class="table is-fullwidth is-narrow">
                                    <tbody>
                                    {% for event in upcomingEvents %}
                                        <tr>
                                            <td>{{ event.start|date('Y-m-d') }}</td>
                                            <td>
                                                <a href="{{ path('app_admin_event_edit', {'id': event.id}) }}">
                                                    {{ event.getTitle('en')|u.truncate(25) }}
                                                </a>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                    </tbody>
                                </table>
                            {% endif %}
                        </div>
                    </div>
                    <div class="column is-6">
                        <div class="box">
                            <h2 class="title is-6">Past Events (no photos)</h2>
                            {% if pastEventsNoPhotos|length == 0 %}
                                <p class="has-text-grey">All past events have photos</p>
                            {% else %}
                                <table class="table is-fullwidth is-narrow">
                                    <tbody>
                                    {% for event in pastEventsNoPhotos %}
                                        <tr>
                                            <td>{{ event.start|date('Y-m-d') }}</td>
                                            <td>
                                                <a href="{{ path('app_admin_event_edit', {'id': event.id}) }}">
                                                    {{ event.getTitle('en')|u.truncate(25) }}
                                                </a>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                    </tbody>
                                </table>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="box">
                    <h2 class="title is-6">Pages not found (this week)</h2>
                    <canvas id="notFoundChart" style="max-height: 200px;"></canvas>
                </div>

                <div class="box">
                    <h2 class="title is-6">Login activity (this week)</h2>
                    <canvas id="loginChart" style="max-height: 200px;"></canvas>
                </div>
            </div>

            <div class="column is-4">
                <div class="box">
                    <h2 class="title is-6">Statistics</h2>
                    <table class="table is-narrow is-fullwidth">
                        <thead>
                            <tr>
                                <th>Metric</th>
                                <th class="has-text-right">All</th>
                                <th class="has-text-right">Week</th>
                            </tr>
                        </thead>
                        <tbody>
                        {% for title, data in details %}
                            <tr>
                                <td>{{ title }}</td>
                                <td class="has-text-right">{{ data.count }}</td>
                                <td class="has-text-right">{{ data.week }}</td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>

                <div class="box">
                    <h2 class="title is-6">User Status</h2>
                    <table class="table is-narrow is-fullwidth">
                        <tbody>
                        {% for status, count in userStatusBreakdown %}
                            <tr>
                                <td>{{ status }}</td>
                                <td class="has-text-right">{{ count }}</td>
                            </tr>
                        {% endfor %}
                        <tr class="has-background-light">
                            <td><strong>Active (7 days)</strong></td>
                            <td class="has-text-right"><strong>{{ activeUsers }}</strong></td>
                        </tr>
                        </tbody>
                    </table>
                </div>

                <div class="box">
                    <h2 class="title is-6">Activity</h2>
                    <table class="table is-narrow is-fullwidth">
                        <tbody>
                            <tr>
                                <td>RSVP Yes (week)</td>
                                <td class="has-text-right has-text-success">{{ rsvpStats.yes }}</td>
                            </tr>
                            <tr>
                                <td>RSVP No (week)</td>
                                <td class="has-text-right has-text-danger">{{ rsvpStats.no }}</td>
                            </tr>
                            <tr>
                                <td>Messages Total</td>
                                <td class="has-text-right">{{ messageStats.total }}</td>
                            </tr>
                            <tr>
                                <td>Messages Unread</td>
                                <td class="has-text-right">{{ messageStats.unread }}</td>
                            </tr>
                            <tr>
                                <td>Social Connections</td>
                                <td class="has-text-right">{{ socialStats.total }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="box">
                    <h2 class="title is-6">Storage</h2>
                    <table class="table is-narrow is-fullwidth">
                        <tbody>
                            <tr>
                                <td>Total Images</td>
                                <td class="has-text-right">{{ imageStats.count }}</td>
                            </tr>
                            <tr>
                                <td>Total Size</td>
                                <td class="has-text-right">{{ (imageStats.totalSize / 1024 / 1024)|number_format(1) }} MB</td>
                            </tr>
                            <tr>
                                <td>This Week</td>
                                <td class="has-text-right">{{ imageStats.weekCount }}</td>
                            </tr>
                            <tr>
                                <td>Recurring Events</td>
                                <td class="has-text-right">{{ recurringEvents }}</td>
                            </tr>
                            <tr>
                                <td>Email Queue</td>
                                <td class="has-text-right">{{ actionItems.pendingEmails }}</td>
                            </tr>
                            {% if emailQueueBreakdown|length > 0 %}
                            <tr>
                                <td colspan="2" class="is-size-7 has-text-grey">
                                    {% for template, count in emailQueueBreakdown %}
                                        {{ template }}: {{ count }}{% if not loop.last %}, {% endif %}
                                    {% endfor %}
                                </td>
                            </tr>
                            {% endif %}
                            <tr>
                                <td>
                                    Email Delivery
                                    <span class="is-size-7 has-text-grey">(24h)</span>
                                </td>
                                <td class="has-text-right">
                                    {% if emailDeliveryStats.total > 0 %}
                                        {{ emailDeliveryRate }}%
                                        <span class="is-size-7 has-text-grey">({{ emailDeliveryStats.sent }}/{{ emailDeliveryStats.total }})</span>
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="box">
                    <h2 class="title is-6">Health Checks</h2>
                    <table class="table is-narrow is-fullwidth">
                        <tbody>
                            <tr>
                                <td>Cache</td>
                                <td class="has-text-right">
                                    {% if tests.cache.ok %}
                                        <span class="icon has-text-success"><i class="fa fa-check-circle"></i></span>
                                    {% else %}
                                        <span class="icon has-text-danger"><i class="fa fa-times-circle"></i></span>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    Log Size
                                    <span class="is-size-7 has-text-grey">({{ (tests.logSize.size / 1024 / 1024)|number_format(1) }}MB)</span>
                                </td>
                                <td class="has-text-right">
                                    {% if tests.logSize.ok %}
                                        <span class="icon has-text-success"><i class="fa fa-check-circle"></i></span>
                                    {% else %}
                                        <span class="icon has-text-warning"><i class="fa fa-exclamation-circle"></i></span>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    Disk Space
                                    <span class="is-size-7 has-text-grey">({{ tests.diskSpace.percentFree }}% free)</span>
                                </td>
                                <td class="has-text-right">
                                    {% if tests.diskSpace.ok %}
                                        <span class="icon has-text-success"><i class="fa fa-check-circle"></i></span>
                                    {% else %}
                                        <span class="icon has-text-danger"><i class="fa fa-times-circle"></i></span>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    PHP
                                    <span class="is-size-7 has-text-grey">({{ tests.phpVersion.version }})</span>
                                </td>
                                <td class="has-text-right">
                                    {% if tests.phpVersion.ok %}
                                        <span class="icon has-text-success"><i class="fa fa-check-circle"></i></span>
                                    {% else %}
                                        <span class="icon has-text-warning"><i class="fa fa-exclamation-circle"></i></span>
                                    {% endif %}
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    <p class="is-size-7 has-text-grey mt-2">
                        Memory: {{ tests.phpVersion.memoryLimit }} | Max Exec: {{ tests.phpVersion.maxExecution }}s
                    </p>
                </div>

                <div class="box">
                    <h2 class="title is-6">Cron Jobs</h2>
                    {% if lastCommands|length == 0 %}
                        <p class="has-text-grey">No command executions recorded yet</p>
                    {% else %}
                        <table class="table is-narrow is-fullwidth">
                            <tbody>
                            {% for name, log in lastCommands %}
                                <tr>
                                    <td>
                                        {{ name }}
                                        <span class="is-size-7 has-text-grey">
                                            ({{ log.startedAt|date('Y-m-d H:i') }})
                                        </span>
                                    </td>
                                    <td class="has-text-right">
                                        {% if log.status.value == 'success' %}
                                            <span class="icon has-text-success"><i class="fa fa-check-circle"></i></span>
                                        {% elseif log.status.value == 'running' %}
                                            <span class="icon has-text-info"><i class="fa fa-spinner fa-spin"></i></span>
                                        {% elseif log.status.value == 'failed' %}
                                            <span class="icon has-text-danger"><i class="fa fa-times-circle"></i></span>
                                        {% else %}
                                            <span class="icon has-text-warning"><i class="fa fa-clock"></i></span>
                                        {% endif %}
                                    </td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                        <p class="is-size-7 has-text-grey mt-2">
                            24h: {{ commandStats.successful }} succeeded, {{ commandStats.failed }} failed
                        </p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <script type="text/javascript">
        const chartOptions = {
            plugins: {
                legend: {
                    display: false
                }
            }
        };

        new Chart(document.getElementById('notFoundChart'), {
            type: 'bar',
            data: {
                datasets: [{
                    data: [{% for day, number in pagesNotFound.list %}{x: '{{ day }}', y: {{ number }}},{% endfor %}],
                    backgroundColor: 'rgba(255, 99, 132, 0.5)'
                }]
            },
            options: chartOptions
        });

        new Chart(document.getElementById('loginChart'), {
            type: 'bar',
            data: {
                datasets: [{
                    data: [{% for day, count in loginTrend %}{x: '{{ day }}', y: {{ count }}},{% endfor %}],
                    backgroundColor: 'rgba(54, 162, 235, 0.5)'
                }]
            },
            options: chartOptions
        });
    </script>

{% endblock %}
